<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Recent Posts</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 2em;
        }

        #posts {
            margin-top: 1em;
        }

        .new {
            background-color: #e0f7fa;
            color: darkblue;
            padding: 1em;
        }

        .author {
            font-weight: bold;
            color: #00796b;
        }

        .post {
            border-bottom: 1px solid #ccc;
            padding: 1em 0;
        }

        .post:last-child {
            border-bottom: none;
        }

        .timestamp {
            color: #888;
            font-size: 0.9em;
        }
    </style>
</head>

<body>
    <h1>Recent Peace Posts</h1>
    <div id="header"></div>
    <div id="posts">Loading...</div>
    <script>

        /*
        This web page displays recent posts related to peace.   It works by fetching
        RECENT_POSTS.json which contains an rpObj object produced by a BlueSky scraper which
        finds recent posts about peace.   rpObj.posts is the array of post event objects.  Each
        post event object peObj contains metadata, and peObj.post contains the actual post content.
        
        This program keeps a list of all the posts it has previously fetched, and when it fetches new
        recent posts, it updates its list of posts.   It keeps track of which posts are new by using
        the post's uri field, which is unique for the post.
        */
        let audioContext = null;
        let postEvents = [];
        let postEventsByURI = {};

        // Create Buddhist gong sound using Web Audio API
        function playGongSound() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            const duration = 3; // 3 seconds
            const sampleRate = audioContext.sampleRate;
            const buffer = audioContext.createBuffer(1, duration * sampleRate, sampleRate);
            const data = buffer.getChannelData(0);

            // Generate gong-like sound with multiple harmonics
            for (let i = 0; i < buffer.length; i++) {
                const t = i / sampleRate;
                const envelope = Math.exp(-t * 2); // Exponential decay

                // Multiple frequencies for rich gong sound
                const fundamental = 220; // Base frequency
                let sample = 0;
                sample += Math.sin(2 * Math.PI * fundamental * t) * 0.3;
                sample += Math.sin(2 * Math.PI * fundamental * 1.5 * t) * 0.2;
                sample += Math.sin(2 * Math.PI * fundamental * 2.2 * t) * 0.15;
                sample += Math.sin(2 * Math.PI * fundamental * 3.1 * t) * 0.1;
                sample += Math.sin(2 * Math.PI * fundamental * 4.7 * t) * 0.05;

                // Add some noise for metallic quality
                sample += (Math.random() - 0.5) * 0.02 * envelope;

                data[i] = sample * envelope * 0.3; // Keep volume moderate
            }

            const source = audioContext.createBufferSource();
            source.buffer = buffer;

            // Add reverb-like effect
            const gainNode = audioContext.createGain();
            gainNode.gain.setValueAtTime(0.7, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);

            source.connect(gainNode);
            gainNode.connect(audioContext.destination);
            source.start();
        }

        // function that is given a timestamp string and returns the elapsed time since that timestamp
        function getElapsedTime(timestamp) {
            const postTime = new Date(timestamp);
            const now = new Date();
            const elapsed = now - postTime;
            const seconds = Math.floor(elapsed / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            if (hours > 0) return `${hours}h ago`;
            if (minutes > 0) return `${minutes}m ago`;
            return `${seconds}s ago`;
        }

        async function fetchAndDisplayPosts() {
            //playGongSound();
            console.log("Fetching recent posts...");
            try {
                const response = await fetch('RECENT_POSTS.json', { cache: "no-store" });
                if (!response.ok) throw new Error('Network response was not ok');
                // 
                const rpObj = await response.json();
                const rate = rpObj.rate || 0;
                const recentPostEventsArray = rpObj.posts || [];
                console.log("Fetched posts:", recentPostEventsArray);
                // compare this with existing post events and update
                // postEventObjs and postEventObjByURI accordingly
                recentPostEventsArray.forEach(peObj => {
                    const uri = peObj.post.uri
                    console.log("Processing post event object:", uri);
                    const existing = postEventsByURI[uri];
                    if (existing) {
                        console.log("Updating existing post event:", existing);
                        // Update existing post event
                        //Object.assign(existing, peObj);
                        existing.isNew = false;
                    } else {
                        // Add new post event
                        console.log("New post event:", peObj);
                        peObj.isNew = true;
                        postEvents.push(peObj);
                        postEventsByURI[uri] = peObj;
                    }
                });
                postEvents.sort((a, b) => new Date(b.post.createdAt) - new Date(a.post.createdAt));
                const headerDiv = document.getElementById('header');
                // show rate to 1 decimal place
                headerDiv.innerHTML = `<h2>Peace Score: ${rate.toFixed(1)}</h2>`;
                const postsDiv = document.getElementById('posts');
                if (!Array.isArray(postEvents) || postEvents.length === 0) {
                    postsDiv.innerHTML = '<em>No recent posts.</em>';
                    return;
                }
                // Then show author handle and display name, followed by text and
                // timestamps, no titles
                // After timestamps, show elapsed time since that timestamp to
                // current time.  Finally, if the post has a 'rate' show it to one
                // decimal place.
                // If the post is new, add a special class that renders it in blue
                let numNewPosts = 0;
                postsDiv.innerHTML = postEvents.map(peObj => {
                    const post = peObj.post || {};
                    if (peObj.isNew) numNewPosts++;
                    return `
                    <div class="post ${peObj.isNew ? 'new' : ''}">
                        <div class="author">${post.author?.displayName || post.author?.handle || ''}</div>
                        <div>${post.text || ''}</div>
                        <div class="timestamp">${post.createdAt || ''} (${getElapsedTime(post.createdAt)})
                        ${peObj.rate ? ` rate: ${peObj.rate.toFixed(1)}` : ''}
                        </div>
                    </div>`
                }).join('');
                console.log("numNewPosts:", numNewPosts);
                if (numNewPosts > 0) {
                    playGongSound();
                    // play gong again in 0.5 seconds
                    setTimeout(playGongSound, 500);
                }
            } catch (err) {
                document.getElementById('posts').innerHTML = '<em>Error loading posts.</em>';
            }
        }

        fetchAndDisplayPosts();
        setInterval(fetchAndDisplayPosts, 15000);
    </script>
</body>

</html>