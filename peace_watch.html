<!DOCTYPE html>
<html lang="en">
<!--
This HTML document displays recent posts related to peace.
It also displays a chart of post engagement over time.  The chart reads
left to right, with the left edge corresponding to the current time, and
positions to the right shows past posts.   The chart shows both a marker
for the post, and an evelope function above the markers that is a smoothed
estimate of the rate.

The posts, and times associated with them are in the postEvents array which
is periodically updated.
-->

<head>
    <meta charset="UTF-8">
    <title>Recent Posts</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 2em;
        }

        #posts {
            margin-top: 1em;
        }

        canvas {
            border: 1px solid #ccc;
            margin-top: 1em;
        }

        .new {
            background-color: #e0f7fa;
            color: darkblue;
            padding: 1em;
        }

        .author {
            font-weight: bold;
            color: #00796b;
        }

        .post {
            border-bottom: 1px solid #ccc;
            padding: 1em 0;
        }

        .post:last-child {
            border-bottom: none;
        }

        .timestamp {
            color: #888;
            font-size: 0.9em;
        }
    </style>
    <!-- Include PeaceTreeData class -->
    <script src="PeaceTreeData.js"></script>
    <!-- Include the PeaceTreeChart class -->
    <script src="PeaceTreeChart.js"></script>
    <!-- Include the Gong sound helper -->
    <script src="Gong.js"></script>
</head>

<body>
    <h1>Recent Peace Posts</h1>
    <div id="header"></div>
    <div id="chart"></div>
    <div style="position: relative; width: 90%; margin-top: 4px; height: 1.8em;">
        <span id="currentTimeStr" style="font-size: 0.95em; color: #555; position: absolute; left: 0; top: 0;"></span>
        <div id="buttons"
            style="position: absolute; left: 50%; top: 0; transform: translateX(-50%); display: inline-block; text-align: center;">
            <input type="checkbox" id="sounds" onchange="onAudioCheckboxChange()"> sounds
            &nbsp; &nbsp;
            <input type="button" value="1 Hour" onclick="chart.setViewDuration(3600)">
            <input type="button" value="12 Hours" onclick="chart.setViewDuration(43200)">
            <input type="button" value="1 Day" onclick="chart.setViewDuration(86400)">
            <input type="button" value="..." onclick="chart.setViewFull()">
            &nbsp; &nbsp;
            <input type="button" value="In" onclick="chart.zoom(0.8)">
            <input type="button" value="Out" onclick="chart.zoom(1.2)">
        </div>
        <span id="startTimeStr"
            style="font-size: 0.95em; color: #555; position: absolute; right: 0; top: 0; text-align: right;"></span>
    </div>
    <div id="xxx">
        <input id="loadLongTermDataBtn" type="button" value="Load Long-Term Data" onclick="loadLongTermData()">
        <span id="status">...</span>
    </div>
    <div id="posts">Loading...</div>
    <script>
        /*
        This web page displays recent posts related to peace.   It works by fetching
        RECENT_POSTS.json which contains an rpObj object produced by a BlueSky scraper which
        finds recent posts about peace.   rpObj.posts is the array of post event objects.  Each
        post event object peObj contains metadata, and peObj.post contains the actual post content.
        
        This program keeps a list of all the posts it has previously fetched, and when it fetches new
        recent posts, it updates its list of posts.   It keeps track of which posts are new by using
        the post's uri field, which is unique for the post.
        */
        let numPostsLoaded = 0;
        // Removed: let audioContext = null;  // now managed inside Gong.js
        let postEvents = [];
        let postEventsByURI = {};
        let chart = null;
        let eventsFromDATA = null;
        const peaceTreeData = new PeaceTreeData();  // NEW instance

        function getCurrentClockTime() {
            return Math.floor(Date.now() / 1000);
        }

        // write function that gets called when "audio" checkbox
        // changes.   If it goes to true, call playAudio()
        function onAudioCheckboxChange() {
            const audioCheckbox = document.getElementById('sounds');
            if (audioCheckbox.checked) {
                playAudio();
            }
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp * 1000);
            // Format: MM/DD/YY HH:MM:SS
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            const yy = String(date.getFullYear()).slice(-2);
            const time = date.toLocaleTimeString();
            return `${mm}/${dd}/${yy} ${time}`;
        }

        function updateChart() {
            if (chart) {
                chart.draw();
                // Update time labels under chart
                const currentTimeLabel = document.getElementById('currentTimeStr');
                const startTimeLabel = document.getElementById('startTimeStr');
                const now = getCurrentClockTime();
                currentTimeLabel.textContent = formatTime(now);
                startTimeLabel.textContent = formatTime(now - chart.viewDuration);
            }
        }

        function showStatus(msg) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = msg;
        }

        function playAudio() {
            if (document.getElementById('sounds').checked) {
                playGongSound(); // from Gong.js
            }
        }

        // function that is given a timestamp string and returns the elapsed time since that timestamp
        function getElapsedTime(timestamp) {
            const postTime = new Date(timestamp);
            const now = new Date();
            const elapsed = now - postTime;
            const seconds = Math.floor(elapsed / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            if (hours > 0) return `${hours}h ago`;
            if (minutes > 0) return `${minutes}m ago`;
            return `${seconds}s ago`;
        }

        // Fetch recent posts and display them.  Ideally this will be
        // replaced by code that uses websockets to update each new post
        // but for not this reloads the file of recent posts, and ignores
        // posts that have already been loaded
        async function handleRecentPosts() {
            console.log("Fetching recent posts...");
            try {
                const response = await fetch('RECENT_POSTS.json', { cache: "no-store" });
                if (!response.ok) throw new Error('Network response was not ok');
                // 
                const rpObj = await response.json();
                const rate = rpObj.rate || 0;
                const recentPostEventsArray = rpObj.posts || [];
                //console.log("Fetched posts:", recentPostEventsArray);
                // compare this with existing post events and update
                // postEventObjs and postEventObjByURI accordingly
                recentPostEventsArray.forEach(peObj => {
                    const uri = peObj.post.uri
                    //console.log("Processing post event object:", uri);
                    let existing = postEventsByURI[uri];
                    if (existing) {
                        //console.log("Updating existing post event:", existing);
                        existing.isNew = false;
                    } else {
                        // Add new post event
                        console.log("New post event:", peObj);
                        peObj.isNew = true;
                        postEvents.push(peObj);
                        postEventsByURI[uri] = peObj; // <-- Add this line
                    }
                });
                postEvents.sort((a, b) => new Date(b.post.createdAt) - new Date(a.post.createdAt));
                const headerDiv = document.getElementById('header');
                // show rate to 1 decimal place
                headerDiv.innerHTML = `<h2>Peace Score: ${rate.toFixed(1)}</h2>`;
                const postsDiv = document.getElementById('posts');
                if (!Array.isArray(postEvents) || postEvents.length === 0) {
                    postsDiv.innerHTML = '<em>No recent posts.</em>';
                    return;
                }
                // Then show author handle and display name, followed by text and
                // timestamps, no titles
                // After timestamps, show elapsed time since that timestamp to
                // current time.  Finally, if the post has a 'rate' show it to one
                // decimal place.
                // If the post is new, add a special css class that renders it in blue
                let numNewPosts = 0;
                postsDiv.innerHTML = postEvents.map(peObj => {
                    const post = peObj.post || {};
                    if (peObj.isNew) numNewPosts++;
                    return `
                    <div class="post ${peObj.isNew ? 'new' : ''}">
                        <div class="author">${post.author?.displayName || post.author?.handle || ''}</div>
                        <div>${post.text || ''}</div>
                        <div class="timestamp">${post.createdAt || ''} (${getElapsedTime(post.createdAt)})
                        ${peObj.rate ? ` rate: ${peObj.rate.toFixed(1)}` : ''}
                        </div>
                    </div>`
                }).join('');
                console.log("numNewPosts:", numNewPosts);
                if (numNewPosts > 0) {
                    playAudio();
                }
            } catch (err) {
                document.getElementById('posts').innerHTML = '<em>Error loading posts.</em>';
            }
            if (chart) {
                chart.draw();
            }
        }

        function handlePost(pEvt) {
            numPostsLoaded++;
            // update status to show numPosts
            showStatus(`Loaded ${numPostsLoaded} posts...`);
            //return;
            const uri = pEvt.post.uri;
            if (uri === undefined) {
                console.warn("***Post event has no URI:", pEvt);
                return; // skip if no uri
            }
            pEvt.isNew = false; // no old events are considered new
            const existing = postEventsByURI[uri];
            if (existing) {
                //console.log("Skipping existing post:", uri);
                return; // skip if already have it
            }
            postEvents.push(pEvt);
            postEventsByURI[uri] = pEvt;
        }

        async function loadLongTermData() {
            if (eventsFromDATA) {
                return;
            }
            numPostsLoaded = 0;
            console.log("Loading long term data from PeaceTreeData...");
            showStatus("Loading long term data...");
            peaceTreeData.setPostHandler(handlePost); // set handler to renderPost
            const postEvts = await peaceTreeData.streamData();
            eventsFromDATA = postEvts; // preserve original side effect

            let numPostsSeen = 0;
            let numPostsAdded = 0;
            postEvts.forEach(pEvt => {
                numPostsSeen++;
                const uri = pEvt.post.uri;
                if (uri === undefined) {
                    console.warn("Post event has no URI:", pEvt);
                    return; // skip if no uri
                }
                const existing = postEventsByURI[uri];
                if (existing) {
                    existing.isNew = false;
                } else {
                    //pEvt.isNew = true;
                    pEvt.isNew = false; // no old events are considered new
                    postEvents.push(pEvt);
                    postEventsByURI[uri] = pEvt;
                    numPostsAdded++;
                }
            });
            console.log(`Seen ${numPostsSeen} posts`);
            console.log(`Added ${numPostsAdded} new posts`);
            postEvents.sort((a, b) => new Date(b.post.createdAt) - new Date(a.post.createdAt));
            // hide load long term button
            document.getElementById('loadLongTermDataBtn').style.display = 'none';
            showStatus(`Loaded ${numPostsLoaded} posts`);
        }

        chart = new PeaceTreeChart();
        handleRecentPosts();
        setInterval(handleRecentPosts, 10000);
        setInterval(updateChart, 100);
    </script>
</body>

</html>