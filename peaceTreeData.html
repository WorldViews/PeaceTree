<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>PeaceTree Data Viewer</title>
    <script src="PeaceTreeData.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 1.5em;
        }

        h1 {
            margin-top: 0;
        }

        #controls {
            margin-bottom: 1em;
        }

        .postBlock {
            border: 1px solid #ccc;
            padding: 0.6em 0.8em;
            margin: 0 0 0.8em 0;
            background: #f9f9f9;
            font-family: Consolas, Menlo, monospace;
            white-space: pre-wrap;
            word-break: break-word;
        }

        #status {
            font-size: 0.9em;
            color: #555;
            margin-bottom: 1em;
        }
    </style>
</head>

<body>
    <h1>PeaceTree Long-Term Data</h1>
    <div id="controls">
        <button id="loadBtn">Load / Reload Data_LOG.json</button>
    </div>
    <div id="status">Idle.</div>
    <div id="postsContainer">No data loaded yet.</div>

    <script>
        console.log("Starting PeaceTree Data Viewer...");
        const peaceTreeData = new PeaceTreeData(renderPost); // fixed ctor use
        const statusEl = document.getElementById('status');
        const postsContainer = document.getElementById('postsContainer');
        const loadBtn = document.getElementById('loadBtn');
        let numPosts = 0;

        // Batching state
        let fragment = document.createDocumentFragment();
        let batchCount = 0;
        const BATCH_SIZE = 200;
        let scheduledFlush = false;

        function showStatus(msg) { statusEl.textContent = msg; }

        function flushFragment() {
            if (fragment.childNodes.length) {
                postsContainer.appendChild(fragment);
                fragment = document.createDocumentFragment();
            }
            batchCount = 0;
            scheduledFlush = false;
        }

        function scheduleFlush() {
            if (scheduledFlush) return;
            scheduledFlush = true;
            requestAnimationFrame(flushFragment);
        }

        function renderPost(post) {
            numPosts++;
            if (numPosts === 1) {
                postsContainer.textContent = ""; // fast clear
            }
            if (numPosts % 500 === 0) {
                showStatus(`Loaded ${numPosts} posts...`);
            }

            const div = document.createElement('div');
            div.className = 'postBlock';
            // Keep it light: avoid heavy JSON pretty for huge volumes; optional:
            div.textContent = JSON.stringify(post, null, 2);
            //div.textContent = `post ${numPosts}`; // replicate previous behavior

            fragment.appendChild(div);
            batchCount++;

            if (batchCount >= BATCH_SIZE) {
                flushFragment();
            } else {
                scheduleFlush();
            }
        }

        async function loadData() {
            console.log("loadData DATA_LOG.json ...");
            showStatus("Loading DATA_LOG.json ...");
            postsContainer.textContent = "Loading...";
            numPosts = 0;
            fragment = document.createDocumentFragment();
            batchCount = 0;
            scheduledFlush = false;
            try {
                await peaceTreeData.streamData(); // await the async stream
                flushFragment(); // ensure remaining nodes appended
                showStatus(`Loaded ${numPosts} posts.`);
            } catch (e) {
                showStatus("Error loading data.");
                postsContainer.innerHTML = "<strong>Error loading data.</strong>";
                console.error(e);
            }
        }

        loadBtn.addEventListener('click', loadData);
    </script>
</body>

</html>